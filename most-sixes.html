<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poster Studio â€” Pro (All Features) - Fixed</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#071026; --panel:#071427; --accent:#00eaff; --muted:#9fb0c6; --gold:#f7c948; --card-radius:12px; }
  *{box-sizing:border-box}
  body{ margin:0;padding:16px;background:linear-gradient(180deg,#020318 0%,#071026 100%); font-family:Inter,system-ui,Arial;color:#fff;display:flex;gap:14px;min-height:100vh; }
  .canvas-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:14px}
  .preview-controls{width:1080px;display:flex;gap:10px;justify-content:flex-end;align-items:center}
  .capture { width:1080px;height:1350px;border-radius:18px;padding:28px; background:var(--bg);position:relative;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.6); transition:all .3s ease; }
  .capture *, .capture { transition: all 300ms ease; }
  .headline{ text-align:center;font-family:'Bebas Neue',sans-serif; font-size:56px;color:var(--accent);letter-spacing:2px;margin-bottom:12px; text-shadow:0 6px 28px rgba(0,234,255,0.08),0 0 18px rgba(0,234,255,0.12); display:flex;align-items:center;justify-content:center;gap:10px; }
  .bg-stadium{ background-image: radial-gradient(circle at 20% 10%, rgba(255,255,255,0.02), transparent 10%), linear-gradient(150deg,#071026 0%, #07112a 100%); }
  .bg-darkneon{ background: linear-gradient(135deg,#020616,#07142a); }
  .bg-tricolor{ background: linear-gradient(180deg,#ff9933 0%, #ffffff 50%, #138808 100%); color:#071022; }
  .bg-fire{ background: linear-gradient(135deg,#2b0600,#6b0f00); }
  .bg-blur{ background: linear-gradient(135deg,#0e2442,#111530); }
  .bg-all{ background: linear-gradient(135deg,#061626,#2b0a1a); }
  .effects-overlay{ position:absolute; inset:0; pointer-events:none; mix-blend-mode:overlay; }
  .layout-single{ display:flex; gap:20px; align-items:center; height:calc(100% - 120px); }
  .single-left{ width:55%; height:100%; border-radius:12px; overflow:hidden; position:relative; }
  .single-left .img-frame{ width:100%; height:100%; background:#081424; position:relative; overflow:hidden; }
  .single-left .img-frame img{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); max-width:none; min-width:100%; min-height:100%; object-fit:cover; transition:transform .12s ease; user-select:none; pointer-events:none; }
  .single-right{ flex:1; padding:20px; display:flex;flex-direction:column; justify-content:center; gap:12px; }
  .name-large{ font-family:'Bebas Neue'; font-size:46px; color:#fff; text-shadow:0 4px 24px rgba(0,0,0,0.6); }
  .team-small{ color:var(--muted); font-weight:600; }
  .stat-big{ font-family:'Bebas Neue'; font-size:110px; color:var(--gold); line-height:0.85; text-shadow: 0 8px 40px rgba(247,201,72,0.08); }
  .layout-list{ display:flex;flex-direction:column; gap:12px; max-height:calc(100% - 120px); overflow:auto; padding-right:8px; }
  .player-card{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:rgba(255,255,255,0.03); }
  .player-thumb{ width:140px;height:140px;border-radius:10px;object-fit:cover;border:4px solid rgba(255,255,255,0.03); }
  .stats-grid{ display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; margin-top:8px; }
  .stat-pill{ padding:8px 10px; background:rgba(0,0,0,0.35); border-radius:8px; font-weight:700; font-size:14px; text-align:center; }
  .brand{ position:absolute; left:26px; bottom:18px; color:rgba(255,255,255,0.12); font-weight:700; }
  .panel{ width:420px;background:linear-gradient(180deg,#071427,#071424); border-radius:12px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.6); overflow:auto; max-height:94vh;}
  .panel h3{ margin:6px 0 14px 0; color:var(--accent); font-family:'Bebas Neue'; font-size:20px; }
  label{ display:block; color:var(--muted); margin-top:10px; font-weight:600; font-size:13px; }
  input[type="text"], input[type="number"], select, textarea{ width:100%; padding:10px; border-radius:8px; border:none; background:#081a2b; color:#fff; margin-top:8px; }
  .row{ display:flex; gap:8px; margin-top:10px; }
  button{ cursor:pointer; border:none; border-radius:8px; padding:8px 10px; font-weight:700; }
  .btn-accent{ background:var(--accent); color:#04202a; }
  .btn-outline{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
  .small{ font-size:13px; padding:8px 10px; }
  .players-ctrl{ margin-top:12px; display:flex; flex-direction:column; gap:12px; }
  .player-ctrl{ display:flex; gap:10px; align-items:flex-start; padding:10px; background:rgba(255,255,255,0.02); border-radius:10px; }
  .player-ctrl img{ width:68px; height:68px; object-fit:cover; border-radius:8px; }
  .player-ctrl .meta{ flex:1; }
  .player-ctrl input[type="file"]{ display:block; margin-top:8px; color:#fff; }
  .drop-hint{ border:2px dashed rgba(255,255,255,0.03); padding:10px; border-radius:8px; text-align:center; color:var(--muted); margin-top:12px; }
  .flex-between{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .control-row{display:flex;gap:8px;margin-top:8px}
  .color{width:36px;height:36px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);cursor:pointer}
  @media(max-width:1180){ .panel{ width:360px; } .capture{ width:900px;height:1200px; } }
</style>
</head>
<body>

<div class="canvas-wrap">
  <div class="preview-controls">
    <select id="previewFrame" title="Preview frame">
      <option value="none">Studio</option>
      <option value="ig">Instagram 1080Ã—1350</option>
      <option value="yt">YouTube 1920Ã—1080</option>
      <option value="short">Shorts 1080Ã—1920</option>
    </select>
    <button id="togglePreview" class="btn-outline small">Toggle Guides</button>
  </div>

  <div id="capture" class="capture bg-darkneon">
    <div class="headline" id="headlinePreview">
      <input id="headlineText" type="text" value="MOST SIXES" style="font-family:'Bebas Neue';font-size:56px;background:transparent;border:none;color:var(--accent);width:70%;text-align:center;outline:none" />
      <input id="headlineFontSize" type="number" value="56" min="20" max="140" style="width:78px;background:#071a26;border-radius:8px;padding:6px;color:#fff;margin-left:6px;" title="Font size" />
    </div>

    <div id="templateArea" style="height:calc(100% - 120px)"></div>

    <div class="effects-overlay" id="effectsOverlay"></div>
    <div class="brand">YourBrand â€¢ Cricket</div>
  </div>
</div>

<div class="panel">
  <h3>Poster Studio â€” Pro</h3>

  <label>Theme / Background</label>
  <select id="bgSelect">
    <option value="bg-stadium">A â€” Stadium Glow</option>
    <option value="bg-darkneon">B â€” Dark Neon</option>
    <option value="bg-tricolor">C â€” Tricolor</option>
    <option value="bg-fire">D â€” Fire</option>
    <option value="bg-blur">E â€” Gradient Blur</option>
    <option value="bg-all">F â€” Mixed</option>
  </select>

  <label>Layout</label>
  <select id="layoutSelect">
    <option value="single">Single Player</option>
    <option value="dual">Dual Player</option>
    <option value="three">Three Players</option>
    <option value="five">Five Players</option>
  </select>

  <label>Headline Options</label>
  <div class="control-row">
    <select id="headlineFont">
      <option value="'Bebas Neue',sans-serif">Bebas Neue</option>
      <option value="Inter, sans-serif">Inter</option>
      <option value="Arial, sans-serif">Arial</option>
    </select>
    <input id="headlineColor" type="color" value="#00eaff" title="Headline color" />
  </div>

  <label>Effects</label>
  <div class="control-row">
    <label style="font-size:13px">Vignette
      <input id="vignette" type="range" min="0" max="1" step="0.05" value="0.35">
    </label>
    <label style="font-size:13px">Grain
      <input id="grain" type="range" min="0" max="1" step="0.05" value="0.08">
    </label>
  </div>

  <label>Accent Color</label>
  <input id="accentColor" type="color" value="#00eaff">

  <label>Flags</label>
  <!-- ADDED: flag toggle so script doesn't throw -->
  <select id="flagToggle">
    <option value="yes">Show flags</option>
    <option value="no">Hide flags</option>
  </select>

  <label>Smart Highlight Rules</label>
  <div style="font-size:13px;color:var(--muted);margin-top:6px">Highlight Runs & Sixes when above threshold</div>
  <div class="control-row" style="margin-top:8px">
    <input id="runsThreshold" type="number" value="200" style="width:80px" />
    <input id="sixesThreshold" type="number" value="10" style="width:80px" />
  </div>

  <div class="flex-between" style="margin-top:12px">
    <button id="addPlayer" class="btn-accent">+ Add Player</button>
    <button id="saveTemplate" class="btn-outline">Save Template</button>
  </div>

  <div style="margin-top:10px;" class="drop-hint" id="globalDrop">Drag an image here to add a new player</div>

  <div class="players-ctrl" id="playersCtrl"></div>

  <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

  <label>Export</label>
  <div class="control-row">
    <select id="exportType"><option value="png">PNG</option><option value="jpg">JPG</option></select>
    <select id="exportSize"><option value="1080x1350">1080Ã—1350</option><option value="1080x1920">1080Ã—1920</option><option value="1920x1080">1920Ã—1080</option><option value="capture">Current</option></select>
  </div>
  <div style="margin-top:8px" class="control-row">
    <label>Scale <input id="exportScale" type="range" min="1" max="3" value="1" step="0.1"></label>
    <label><input id="transparent" type="checkbox"> Transparent PNG</label>
  </div>

  <div class="flex-between" style="margin-top:12px">
    <button id="exportBtn" class="btn-accent">Export Image</button>
    <button id="exportJson" class="btn-outline">Export JSON</button>
  </div>

  <div style="margin-top:8px" class="flex-between">
    <button id="importJsonBtn" class="btn-outline">Import JSON</button>
    <input id="jsonFile" type="file" accept=".json" style="display:none">
  </div>

  <div style="margin-top:12px" class="flex-between">
    <button id="resetDemo" class="btn-outline small">Reset Demo</button>
    <button id="clearAll" class="btn-outline small">Clear All</button>
  </div>

  <p style="color:var(--muted);font-size:13px;margin-top:12px">
    Changes autosave locally. Use Export JSON to save project, Import JSON to load.
  </p>
</div>

<script>
/* -------------------------
   Fixed Poster Studio core
   ------------------------- */

/* fallback 1x1 transparent gif to avoid broken-image icon */
const PLACEHOLDER_1PX = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

/* --- state --- */
let players = JSON.parse(localStorage.getItem('ps_players') || 'null');
if(!Array.isArray(players)){
  players = [
    { name:'Rohit Sharma', team:'India', flag:'ðŸ‡®ðŸ‡³', stat:{Runs:219,Sixes:12,SR:132.1,Avg:54.8,Innings:7,Matches:8,Economy:0}, img:'', pos:{x:50,y:50,scale:1}, locked:false },
    { name:'Chris Gayle', team:'West Indies', flag:'ðŸ‡»ðŸ‡®', stat:{Runs:198,Sixes:10,SR:129.6,Avg:39.6,Innings:5,Matches:6,Economy:0}, img:'', pos:{x:50,y:50,scale:1}, locked:false }
  ];
}

const capture = document.getElementById('capture');
const templateArea = document.getElementById('templateArea');
const playersCtrl = document.getElementById('playersCtrl');

/* helpers */
function saveState(){ localStorage.setItem('ps_players', JSON.stringify(players)); }
function clearEl(el){ while(el.firstChild) el.removeChild(el.firstChild); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* render canvas according to layout */
function renderCanvas(){
  try {
    // theme/background
    const bg = document.getElementById('bgSelect').value;
    capture.className = 'capture ' + bg;

    // headline
    const hf = document.getElementById('headlineFont').value || "'Bebas Neue',sans-serif";
    const ht = document.getElementById('headlineText').value || 'MOST SIXES';
    const hsize = Number(document.getElementById('headlineFontSize').value) || 56;
    const hcolor = document.getElementById('headlineColor').value || '#00eaff';
    document.getElementById('headlinePreview').style.fontFamily = hf;
    document.getElementById('headlineText').style.color = hcolor;
    document.getElementById('headlineText').style.fontSize = hsize + 'px';

    // effects overlay (vignette + grain)
    const vign = Number(document.getElementById('vignette').value);
    const grain = Number(document.getElementById('grain').value);
    const effectsOverlay = document.getElementById('effectsOverlay');
    effectsOverlay.innerHTML = '';
    effectsOverlay.style.pointerEvents = 'none';

    const v = document.createElement('div');
    v.style.position='absolute'; v.style.inset='0';
    v.style.background = `radial-gradient(ellipse at center, rgba(0,0,0,${vign*0.2}) 0%, rgba(0,0,0,${vign}) 80%)`;
    v.style.mixBlendMode='multiply'; v.style.pointerEvents='none';
    effectsOverlay.appendChild(v);

    if(grain>0){
      const g = document.createElement('div');
      g.style.position='absolute'; g.style.inset='0';
      g.style.backgroundImage = `url(${createNoiseDataURL(Math.round(grain*2)||1)})`;
      g.style.opacity = Math.min(0.6, grain); g.style.pointerEvents='none';
      effectsOverlay.appendChild(g);
    }

    // layout
    clearEl(templateArea);
    const layout = document.getElementById('layoutSelect').value;
    const flagEl = document.getElementById('flagToggle');
    const showFlags = flagEl ? flagEl.value === 'yes' : true;

    if(layout === 'single'){
      const p = players[0] || {name:'Player',team:'Team',flag:'',stat:{},img:'',pos:{x:50,y:50,scale:1}};
      const container = document.createElement('div'); container.className='layout-single';

      const left = document.createElement('div'); left.className='single-left';
      const frame = document.createElement('div'); frame.className='img-frame';
      const img = document.createElement('img'); img.src = p.img || PLACEHOLDER_1PX;
      img.alt = p.name;
      img.style.transform = `translate(-50%,-50%) translate(${p.pos.x-50}%,${p.pos.y-50}%) scale(${p.pos.scale})`;
      frame.appendChild(img);
      if(!p.locked) attachImageDrag(img, p);
      left.appendChild(frame);

      const right = document.createElement('div'); right.className='single-right';
      const name = document.createElement('div'); name.className='name-large';
      name.textContent = (showFlags && p.flag ? (p.flag + ' ') : '') + p.name;
      const team = document.createElement('div'); team.className='team-small'; team.textContent = p.team;
      const statBig = document.createElement('div'); statBig.className='stat-big';
      statBig.textContent = p.stat.Runs || 0;

      const statsGrid = document.createElement('div'); statsGrid.className='stats-grid';
      const statList = ['Runs','Sixes','SR','Avg','Innings','Matches','Economy'];
      statList.forEach(k => {
        const pill = document.createElement('div'); pill.className='stat-pill';
        const val = p.stat[k] !== undefined ? p.stat[k] : (k==='SR' ? (p.stat['SR']||0) : 0);
        pill.innerHTML = `<div style="font-size:12px;color:var(--muted)">${k}</div><div style="font-size:16px">${val}</div>`;
        statsGrid.appendChild(pill);
        const runsT = Number(document.getElementById('runsThreshold').value||0);
        const sixesT = Number(document.getElementById('sixesThreshold').value||0);
        if(k==='Runs' && Number(val) >= runsT) pill.style.background = 'linear-gradient(90deg,#ffd966,#f7c948)';
        if(k==='Sixes' && Number(val) >= sixesT) pill.style.background = 'linear-gradient(90deg,#ff9b5c,#ff6b3a)';
      });

      right.appendChild(name); right.appendChild(team); right.appendChild(statBig); right.appendChild(statsGrid);
      container.appendChild(left); container.appendChild(right);
      templateArea.appendChild(container);
      animateNumber(statBig, Number(p.stat.Runs||0), 900);
    } else {
      const list = document.createElement('div'); list.className='layout-list';
      let count = 3;
      if(layout==='dual') count=2; if(layout==='three') count=3; if(layout==='five') count=Math.min(5,players.length||5);
      const showPlayers = players.slice(0,count);
      showPlayers.forEach(p=>{
        const card = document.createElement('div'); card.className='player-card';
        const thumbFrame = document.createElement('div'); thumbFrame.style.width='140px'; thumbFrame.style.height='140px'; thumbFrame.style.overflow='hidden'; thumbFrame.style.borderRadius='12px';
        const thumb = document.createElement('img'); thumb.className='player-thumb'; thumb.src = p.img || PLACEHOLDER_1PX; thumb.style.transform = `translate(${p.pos.x-50}%,${p.pos.y-50}%) scale(${p.pos.scale})`;
        if(!p.locked) attachImageDrag(thumb,p);
        thumbFrame.appendChild(thumb);
        const info = document.createElement('div'); info.style.flex='1';
        const name = document.createElement('div'); name.style.fontWeight=800; name.style.fontSize='20px'; name.textContent = (showFlags && p.flag ? (p.flag + ' ') : '') + p.name;
        const team = document.createElement('div'); team.style.color='var(--muted)'; team.style.marginTop='6px'; team.textContent = p.team;
        const statRow = document.createElement('div'); statRow.className='stats-grid';
        ['Runs','Sixes','SR','Avg','Innings','Matches','Economy'].forEach(k=>{
          const pill = document.createElement('div'); pill.className='stat-pill';
          const val = p.stat[k] !== undefined ? p.stat[k] : '';
          pill.innerHTML = `<div style="font-size:12px;color:var(--muted)">${k}</div><div style="font-size:14px">${val}</div>`;
          statRow.appendChild(pill);
          if(k==='Runs' && Number(val) >= Number(document.getElementById('runsThreshold').value||0)) pill.style.background='linear-gradient(90deg,#ffd966,#f7c948)';
          if(k==='Sixes' && Number(val) >= Number(document.getElementById('sixesThreshold').value||0)) pill.style.background='linear-gradient(90deg,#ff9b5c,#ff6b3a)';
        });
        info.appendChild(name); info.appendChild(team); info.appendChild(statRow);
        card.appendChild(thumbFrame); card.appendChild(info);
        list.appendChild(card);
      });
      templateArea.appendChild(list);
    }
    saveState();
  } catch(err){
    console.error('renderCanvas error', err);
  }
}

/* attach drag to reposition image inside its frame */
function attachImageDrag(imgEl, player){
  let dragging = false;
  let startX=0,startY=0, startLeft=player.pos.x, startTop=player.pos.y;
  imgEl.style.cursor='grab';
  const onDown = (e) => {
    if(player.locked) return;
    dragging = true; imgEl.style.cursor='grabbing';
    startX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
    startY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
    startLeft = player.pos.x; startTop = player.pos.y;
    e.preventDefault();
  };
  const onMove = (e) => {
    if(!dragging) return;
    const clientX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
    const clientY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
    const dx = (clientX - startX) / (imgEl.parentElement.clientWidth) * 100;
    const dy = (clientY - startY) / (imgEl.parentElement.clientHeight) * 100;
    player.pos.x = clamp(startLeft + dx, -100, 200);
    player.pos.y = clamp(startTop + dy, -100, 200);
    imgEl.style.transform = `translate(-50%,-50%) translate(${player.pos.x-50}%,${player.pos.y-50}%) scale(${player.pos.scale})`;
  };
  const onUp = () => { if(dragging){ dragging=false; imgEl.style.cursor='grab'; saveState(); } };
  imgEl.addEventListener('pointerdown', onDown);
  window.addEventListener('pointermove', onMove);
  window.addEventListener('pointerup', onUp);
}

/* players control panel - drag reorder etc */
function renderPlayersControls(){
  clearEl(playersCtrl);
  players.forEach((p,idx)=>{
    const div = document.createElement('div'); div.className='player-ctrl';
    div.draggable = true;
    div.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', idx); div.style.opacity=0.5; });
    div.addEventListener('dragend', ()=>{ div.style.opacity=1; });

    div.addEventListener('drop', e=>{
      e.preventDefault();
      const from = Number(e.dataTransfer.getData('text/plain'));
      const to = idx;
      if(!Number.isNaN(from) && from !== to){
        const item = players.splice(from,1)[0];
        players.splice(to,0,item);
        renderPlayersControls(); renderCanvas();
      }
    });
    div.addEventListener('dragover', e=>e.preventDefault());

    const thumb = document.createElement('img'); thumb.src = p.img || PLACEHOLDER_1PX; thumb.alt='thumb';
    thumb.style.width='68px'; thumb.style.height='68px'; thumb.style.borderRadius='8px'; thumb.style.objectFit='cover';
    const meta = document.createElement('div'); meta.className='meta';

    const nameInp = document.createElement('input'); nameInp.type='text'; nameInp.value=p.name;
    const teamInp = document.createElement('input'); teamInp.type='text'; teamInp.value=p.team;

    const flagSel = document.createElement('select');
    ['','ðŸ‡®ðŸ‡³','ðŸ‡µðŸ‡°','ðŸ‡¦ðŸ‡º','ðŸ‡¿ðŸ‡¦','ðŸ‡¬ðŸ‡§','ðŸ‡³ðŸ‡¿','ðŸ‡±ðŸ‡°','ðŸ‡§ðŸ‡©','ðŸ‡ºðŸ‡¸','ðŸ‡¯ðŸ‡µ','ðŸ‡»ðŸ‡®'].forEach(f=>{
      const o=document.createElement('option'); o.value=f; o.innerText=f || 'â€”'; if(p.flag===f) o.selected=true; flagSel.appendChild(o);
    });

    const scaleRow = document.createElement('div'); scaleRow.style.display='flex'; scaleRow.style.gap='6px'; scaleRow.style.marginTop='6px';
    const scaleLabel = document.createElement('div'); scaleLabel.textContent='Scale'; scaleLabel.style.fontSize='12px'; scaleLabel.style.color='var(--muted)';
    const scaleInp = document.createElement('input'); scaleInp.type='range'; scaleInp.min=0.5; scaleInp.max=2; scaleInp.step=0.01; scaleInp.value=p.pos.scale || 1;
    scaleInp.addEventListener('input', ()=>{ p.pos.scale = Number(scaleInp.value); renderCanvas(); });

    scaleRow.appendChild(scaleLabel); scaleRow.appendChild(scaleInp);

    const lockBtn = document.createElement('button'); lockBtn.textContent = p.locked ? 'Unlock' : 'Lock'; lockBtn.className='btn-outline small';
    lockBtn.addEventListener('click', ()=>{ p.locked = !p.locked; lockBtn.textContent = p.locked ? 'Unlock' : 'Lock'; renderPlayersControls(); });

    const fileInp = document.createElement('input'); fileInp.type='file'; fileInp.accept='image/*';
    fileInp.addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      // fast preview using object URL (no base64 conversion), then read as base64 for persistence
      const url = URL.createObjectURL(f);
      thumb.src = url;
      const r = new FileReader(); r.onload = ev => { p.img = ev.target.result; renderPlayersControls(); renderCanvas(); saveState(); }; r.readAsDataURL(f);
    });

    const dupBtn = document.createElement('button'); dupBtn.textContent='Duplicate'; dupBtn.className='btn-outline small';
    dupBtn.addEventListener('click', ()=>{ const copy = JSON.parse(JSON.stringify(p)); players.push(copy); renderPlayersControls(); renderCanvas(); saveState(); });
    const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='btn-outline small';
    delBtn.addEventListener('click', ()=>{ players.splice(idx,1); renderPlayersControls(); renderCanvas(); saveState(); });

    const statKeys = ['Runs','Sixes','SR','Avg','Innings','Matches','Economy'];
    const statWrap = document.createElement('div'); statWrap.style.display='grid'; statWrap.style.gridTemplateColumns='repeat(4,1fr)'; statWrap.style.gap='6px'; statWrap.style.marginTop='8px';
    statKeys.forEach(k=>{
      const si = document.createElement('input'); si.type='text'; si.placeholder=k; si.value = p.stat[k] !== undefined ? p.stat[k] : '';
      si.style.padding='6px'; si.style.borderRadius='6px'; si.style.background='#071826'; si.style.border='none'; si.style.color='#fff';
      si.addEventListener('input', ()=>{ p.stat[k] = si.value; renderCanvas(); saveState(); });
      statWrap.appendChild(si);
    });

    nameInp.addEventListener('input', ()=>{ p.name = nameInp.value; renderCanvas(); saveState(); });
    teamInp.addEventListener('input', ()=>{ p.team = teamInp.value; renderCanvas(); saveState(); });
    flagSel.addEventListener('change', ()=>{ p.flag = flagSel.value; renderCanvas(); saveState(); });

    meta.appendChild(nameInp); meta.appendChild(teamInp); meta.appendChild(flagSel); meta.appendChild(scaleRow); meta.appendChild(statWrap); meta.appendChild(fileInp);

    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px'; actions.style.marginLeft='6px';
    actions.appendChild(lockBtn); actions.appendChild(dupBtn); actions.appendChild(delBtn);

    div.appendChild(thumb); div.appendChild(meta); div.appendChild(actions);
    playersCtrl.appendChild(div);
  });
}

/* utility: noise canvas */
function createNoiseDataURL(detail=1){
  const size = 64 * Math.max(1, detail);
  const c = document.createElement('canvas'); c.width=size; c.height=size;
  const ctx = c.getContext('2d');
  const img = ctx.createImageData(size,size);
  for(let i=0;i<img.data.length;i+=4){
    const v = Math.floor(Math.random()*255);
    img.data[i]=v; img.data[i+1]=v; img.data[i+2]=v; img.data[i+3]=Math.floor(10 + Math.random()*30);
  }
  ctx.putImageData(img,0,0);
  return c.toDataURL('image/png');
}

/* animate number helper */
function animateNumber(el, target, duration=700){
  const start = Number(el.textContent.replace(/\D/g,'')) || 0;
  const diff = target - start;
  if(diff===0){ el.textContent = target; return; }
  const frames = Math.max(12, Math.min(60, Math.floor(duration/16)));
  let f=0;
  const id = setInterval(()=>{ f++; const v = Math.round(start + diff*(f/frames)); el.textContent = v; if(f>=frames) clearInterval(id); }, Math.max(10, Math.floor(duration/frames)));
}

/* export */
async function exportImage(){
  const type = document.getElementById('exportType').value;
  const size = document.getElementById('exportSize').value;
  let width = capture.clientWidth; let height = capture.clientHeight;
  if(size!=='capture'){ [width,height] = size.split('x').map(Number); }
  const scale = Number(document.getElementById('exportScale').value) || 1;
  const transparent = document.getElementById('transparent').checked;
  const canvas = await html2canvas(capture, {scale: scale, useCORS:true, backgroundColor: transparent?null:'#000'});
  let final = canvas;
  if(canvas.width !== width || canvas.height !== height){
    final = document.createElement('canvas'); final.width=width; final.height=height;
    const ctx = final.getContext('2d');
    if(!transparent){ ctx.fillStyle='#000'; ctx.fillRect(0,0,width,height); }
    ctx.drawImage(canvas, 0, 0, width, height);
  }
  const dataURL = final.toDataURL(type==='jpg'?'image/jpeg':'image/png', 0.92);
  const a = document.createElement('a'); a.href = dataURL; a.download = `poster_${Date.now()}.${type==='jpg'?'jpg':'png'}`; a.click();
}

/* Save/load JSON */
function exportJSON(){
  const data = { players: JSON.parse(JSON.stringify(players)), settings:{
    bg: document.getElementById('bgSelect').value,
    layout: document.getElementById('layoutSelect').value,
    headline: document.getElementById('headlineText').value
  }};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='poster_project.json'; a.click();
}
function importJSON(file){
  const r = new FileReader();
  r.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      if(data.players) players = data.players;
      if(data.settings){
        if(data.settings.bg) document.getElementById('bgSelect').value = data.settings.bg;
        if(data.settings.layout) document.getElementById('layoutSelect').value = data.settings.layout;
        if(data.settings.headline) document.getElementById('headlineText').value = data.settings.headline;
      }
      renderPlayersControls(); renderCanvas();
    }catch(err){ alert('Invalid JSON'); }
  };
  r.readAsText(file);
}

/* drag-drop to add player */
const globalDrop = document.getElementById('globalDrop');
globalDrop.addEventListener('dragover', e=>{ e.preventDefault(); globalDrop.style.borderColor='var(--accent)'; });
globalDrop.addEventListener('dragleave', e=>{ globalDrop.style.borderColor='rgba(255,255,255,0.03)'; });
globalDrop.addEventListener('drop', e=>{
  e.preventDefault(); globalDrop.style.borderColor='rgba(255,255,255,0.03)';
  const f = e.dataTransfer.files?.[0]; if(!f || !f.type.startsWith('image/')) return;
  const r = new FileReader(); r.onload = ev => { players.push({name:'New Player',team:'Team',flag:'ðŸ‡®ðŸ‡³',stat:{},img:ev.target.result,pos:{x:50,y:50,scale:1},locked:false}); renderPlayersControls(); renderCanvas(); saveState(); }; r.readAsDataURL(f);
});

/* UI bindings */
document.getElementById('addPlayer').addEventListener('click', ()=>{ players.push({name:'New Player',team:'Team',flag:'ðŸ‡®ðŸ‡³',stat:{Runs:0,Sixes:0,SR:0,Avg:0,Innings:0,Matches:0,Economy:0},img:'',pos:{x:50,y:50,scale:1},locked:false}); renderPlayersControls(); renderCanvas(); saveState(); });
document.getElementById('clearAll').addEventListener('click', ()=>{ if(confirm('Clear all players?')){ players=[]; renderPlayersControls(); renderCanvas(); saveState(); } });
document.getElementById('resetDemo').addEventListener('click', ()=>{ localStorage.removeItem('ps_players'); location.reload(); });
document.getElementById('exportBtn').addEventListener('click', exportImage);
document.getElementById('exportJson').addEventListener('click', exportJSON);
document.getElementById('jsonFile').addEventListener('change', e=> importJSON(e.target.files[0]));
document.getElementById('importJsonBtn').addEventListener('click', ()=> document.getElementById('jsonFile').click());
document.getElementById('saveTemplate').addEventListener('click', ()=> {
  const name = prompt('Template name'); if(!name) return;
  const list = JSON.parse(localStorage.getItem('ps_templates')||'[]');
  list.push({name, players: JSON.parse(JSON.stringify(players)), meta:{bg:document.getElementById('bgSelect').value}});
  localStorage.setItem('ps_templates', JSON.stringify(list)); alert('Saved template: '+name);
});

document.getElementById('headlineText').addEventListener('input', renderCanvas);
document.getElementById('headlineFontSize').addEventListener('input', ()=>{ document.getElementById('headlineText').style.fontSize = document.getElementById('headlineFontSize').value + 'px'; renderCanvas(); });
document.getElementById('headlineColor').addEventListener('input', (e)=>{ document.getElementById('headlineText').style.color = e.target.value; renderCanvas(); });

['bgSelect','layoutSelect','headlineFont','vignette','grain','runsThreshold','sixesThreshold','flagToggle','headlineFontSize','headlineColor','accentColor'].forEach(id=>{
  const el = document.getElementById(id); if(el) el.addEventListener('change', renderCanvas);
});
['vignette','grain','runsThreshold','sixesThreshold'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', renderCanvas); });

document.getElementById('previewFrame').addEventListener('change', (e)=>{
  const v = e.target.value;
  if(v==='ig'){ capture.style.width='1080px'; capture.style.height='1350px'; }
  else if(v==='yt'){ capture.style.width='1920px'; capture.style.height='1080px'; }
  else if(v==='short'){ capture.style.width='1080px'; capture.style.height='1920px'; }
  else { capture.style.width='1080px'; capture.style.height='1350px'; }
});

/* autosave on unload */
window.addEventListener('beforeunload', () => saveState());

/* initial render */
renderPlayersControls(); renderCanvas();

document.getElementById('togglePreview').addEventListener('click', ()=> {
  capture.classList.toggle('show-guides');
});

window.PS = { players, renderCanvas, renderPlayersControls, exportImage, exportJSON, importJSON };

</script>
</body>
</html>
